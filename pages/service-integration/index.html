<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Reliable service communications with a service bus | @node-ts/bus</title>
    <meta name="description" content="Enterprise message bus library for typescript">
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-139036417-1"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-139036417-1');
    </script>
    
    <link rel="preload" href="/bus/assets/css/0.styles.a0567244.css" as="style"><link rel="preload" href="/bus/assets/js/app.3f00092a.js" as="script"><link rel="preload" href="/bus/assets/js/2.f96d54d9.js" as="script"><link rel="preload" href="/bus/assets/js/55.f140ad1b.js" as="script"><link rel="prefetch" href="/bus/assets/js/10.b1826c5f.js"><link rel="prefetch" href="/bus/assets/js/11.f4db49b5.js"><link rel="prefetch" href="/bus/assets/js/12.441ced42.js"><link rel="prefetch" href="/bus/assets/js/13.5da12cdf.js"><link rel="prefetch" href="/bus/assets/js/14.5723ff39.js"><link rel="prefetch" href="/bus/assets/js/15.9351b1f8.js"><link rel="prefetch" href="/bus/assets/js/16.4a95aa27.js"><link rel="prefetch" href="/bus/assets/js/17.5e3a905d.js"><link rel="prefetch" href="/bus/assets/js/18.34d34a41.js"><link rel="prefetch" href="/bus/assets/js/19.37764b15.js"><link rel="prefetch" href="/bus/assets/js/20.41e534df.js"><link rel="prefetch" href="/bus/assets/js/21.a2a519df.js"><link rel="prefetch" href="/bus/assets/js/22.b1b8491f.js"><link rel="prefetch" href="/bus/assets/js/23.2cd80a85.js"><link rel="prefetch" href="/bus/assets/js/24.5c27101b.js"><link rel="prefetch" href="/bus/assets/js/25.eec315db.js"><link rel="prefetch" href="/bus/assets/js/26.578d003c.js"><link rel="prefetch" href="/bus/assets/js/27.b98c2d5c.js"><link rel="prefetch" href="/bus/assets/js/28.49e8268d.js"><link rel="prefetch" href="/bus/assets/js/29.7d5f4608.js"><link rel="prefetch" href="/bus/assets/js/3.bd8ac6f4.js"><link rel="prefetch" href="/bus/assets/js/30.02847ac0.js"><link rel="prefetch" href="/bus/assets/js/31.17c58c6e.js"><link rel="prefetch" href="/bus/assets/js/32.d9080668.js"><link rel="prefetch" href="/bus/assets/js/33.f2ed353a.js"><link rel="prefetch" href="/bus/assets/js/34.08e93c34.js"><link rel="prefetch" href="/bus/assets/js/35.35de18e1.js"><link rel="prefetch" href="/bus/assets/js/36.cbfbdc52.js"><link rel="prefetch" href="/bus/assets/js/37.8a3c22bb.js"><link rel="prefetch" href="/bus/assets/js/38.bd7c4504.js"><link rel="prefetch" href="/bus/assets/js/39.cd720556.js"><link rel="prefetch" href="/bus/assets/js/4.316b1088.js"><link rel="prefetch" href="/bus/assets/js/40.94efec92.js"><link rel="prefetch" href="/bus/assets/js/41.74109087.js"><link rel="prefetch" href="/bus/assets/js/42.f1a36a54.js"><link rel="prefetch" href="/bus/assets/js/43.5c78e474.js"><link rel="prefetch" href="/bus/assets/js/44.063e9286.js"><link rel="prefetch" href="/bus/assets/js/45.e6507e24.js"><link rel="prefetch" href="/bus/assets/js/46.6e36afc9.js"><link rel="prefetch" href="/bus/assets/js/47.667c6c4f.js"><link rel="prefetch" href="/bus/assets/js/48.44225a83.js"><link rel="prefetch" href="/bus/assets/js/49.134f81e0.js"><link rel="prefetch" href="/bus/assets/js/5.2df78ea4.js"><link rel="prefetch" href="/bus/assets/js/50.43c1ca10.js"><link rel="prefetch" href="/bus/assets/js/51.73f85ba2.js"><link rel="prefetch" href="/bus/assets/js/52.7f1417bf.js"><link rel="prefetch" href="/bus/assets/js/53.1ab9955f.js"><link rel="prefetch" href="/bus/assets/js/54.9181bea0.js"><link rel="prefetch" href="/bus/assets/js/56.fb3a6ebe.js"><link rel="prefetch" href="/bus/assets/js/6.2614c5a8.js"><link rel="prefetch" href="/bus/assets/js/7.089ef9d2.js"><link rel="prefetch" href="/bus/assets/js/8.78c5e104.js"><link rel="prefetch" href="/bus/assets/js/9.f03a87d7.js">
    <link rel="stylesheet" href="/bus/assets/css/0.styles.a0567244.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/bus/" class="home-link router-link-active"><!----> <span class="site-name">@node-ts/bus</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/bus/" class="nav-link">Home</a></div><div class="nav-item"><a href="/bus/packages/bus-core/src/handler/" class="nav-link">Handlers</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Transports</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bus/packages/bus-sqs/" class="nav-link">SQS</a></li><li class="dropdown-item"><!----> <a href="/bus/packages/bus-rabbitmq/" class="nav-link">RabbitMQ</a></li></ul></div></div><div class="nav-item"><a href="/bus/packages/bus-workflow/" class="nav-link">Workflows</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Persistence</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bus/packages/bus-postgres/" class="nav-link">Postgres</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/node-ts/bus" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/bus/" class="nav-link">Home</a></div><div class="nav-item"><a href="/bus/packages/bus-core/src/handler/" class="nav-link">Handlers</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Transports</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bus/packages/bus-sqs/" class="nav-link">SQS</a></li><li class="dropdown-item"><!----> <a href="/bus/packages/bus-rabbitmq/" class="nav-link">RabbitMQ</a></li></ul></div></div><div class="nav-item"><a href="/bus/packages/bus-workflow/" class="nav-link">Workflows</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Persistence</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bus/packages/bus-postgres/" class="nav-link">Postgres</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/node-ts/bus" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/bus/" class="sidebar-link">Home</a></li><li><a href="/bus/packages/bus-messages/" class="sidebar-link">Messages</a></li><li><a href="/bus/packages/bus-core/src/handler/" class="sidebar-link">Handlers</a></li><li><a href="/bus/packages/bus-core/src/transport/" class="sidebar-link">Transports</a></li><li><a href="/bus/packages/bus-workflow/" class="sidebar-link">Workflows</a></li><li><a href="/bus/packages/bus-workflow/src/workflow/persistence/" class="sidebar-link">Persistence</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="reliable-service-communications-with-a-service-bus"><a href="#reliable-service-communications-with-a-service-bus" aria-hidden="true" class="header-anchor">#</a> Reliable service communications with a service bus</h1> <p>It's common for services to communicate with each other over HTTP. However this isn't always the best technology choice, and integrating services (or even parts of the same service) using a message bus is much simpler and reliable than you may think.</p> <p>The following examples use <a href="https://github.com/node-ts/bus" target="_blank" rel="noopener noreferrer">@node-ts/bus<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> as the service bus.</p> <h2 id="sending"><a href="#sending" aria-hidden="true" class="header-anchor">#</a> Sending</h2> <p>Consider the need to register a new product for our retail business. This might be modelled like so:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> registerProduct <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegisterProduct</span><span class="token punctuation">(</span><span class="token string">'abc-123'</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">'product a'</span><span class="token punctuation">,</span> price<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">)</span>

<span class="token comment">// Sending the command using an HTTP based API endpoint:</span>
<span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">'https://10.0.0.1:8080/product'</span><span class="token punctuation">,</span> registerProduct<span class="token punctuation">)</span>

<span class="token comment">// Sending the same command using a service bus:</span>
<span class="token keyword">await</span> bus<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>registerProduct<span class="token punctuation">)</span>
</code></pre></div><h3 id="service-discovery"><a href="#service-discovery" aria-hidden="true" class="header-anchor">#</a> Service discovery</h3> <p>When dealing with an HTTP endoint, how do we know that the server is at <code>10.0.0.1</code>, listening on port <code>8080</code>?</p> <ul><li>We might build in a service discovery mechanism. Perhaps build a load balancer and tell it that <code>/product</code> requests need to be routed to a certain cluster of services.</li> <li>Maybe replace the fixed IP with a local DNS entry to make this more reliable</li> <li>Inject or set the configuration of this address per environment</li></ul> <p>When using messaging, the message is ultimately routed to a queue where it will be processed when the service monitoring that queue is ready. Your app doesn't need to know or care where that consumer is, it just needs to send out the command and know that it will eventually be processed.</p> <h3 id="service-availability"><a href="#service-availability" aria-hidden="true" class="header-anchor">#</a> Service Availability</h3> <p>So what happens when the service that processes the request/message is unavailable?</p> <p>Our HTTP request will just fail even though there's nothing wrong with whatever we used to make the request. We've done our work and just want the product to be registered, but now we have to deal with a <code>5xx</code> error in the code.</p> <p>When working with messaging, commands are generally executed quickly - sub 10ms. If the service that processes this command does go down, then the command will sit in the queue until the service is ready and starts processing it again. No changes need to happen to the requesting process, it's fire and forget.</p> <h2 id="receiving"><a href="#receiving" aria-hidden="true" class="header-anchor">#</a> Receiving</h2> <p>Consider processing the above command:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> productService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./product-service'</span>

<span class="token comment">// Using an HTTP based API endpoint</span>
@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token string">'/product'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">controller</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> command <span class="token operator">=</span> request<span class="token punctuation">.</span>body <span class="token keyword">as</span> RegisterProduct
    productService<span class="token punctuation">.</span><span class="token function">registerProduct</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span>
    response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">204</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Using a message handler</span>
@<span class="token function">HandlesMessage</span><span class="token punctuation">(</span>RegisterProduct<span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">RegisterProductHandler</span> <span class="token punctuation">{</span>
  <span class="token function">handler</span> <span class="token punctuation">(</span>command<span class="token punctuation">:</span> RegisterProduct<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    productService<span class="token punctuation">.</span><span class="token function">registerProduct</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="verbs-and-intent"><a href="#verbs-and-intent" aria-hidden="true" class="header-anchor">#</a> Verbs and Intent</h3> <p><code>HTTP Services</code> should ususally conform to the technical specification on what different verbs mean. <code>POST</code>, <code>PUT</code>, <code>PATCH</code> and <code>DELETE</code> are all write operations that create, update or delete resources. This sometimes has the undesired effect of turning APIs into an anemic CRUD system that can discard the rich domain language used by your business.</p> <p><code>Messaging</code> doesn't have these concepts. In fact it's useful to only have two types of intents: read and write, aka events and commands. In the above messaging example, a function receives an intent to perform an action (<code>RegisterProduct</code>) and it does that one thing. The name of the command is understandable even by non-technical users.</p> <h3 id="response-statuses"><a href="#response-statuses" aria-hidden="true" class="header-anchor">#</a> Response Statuses</h3> <p>A key difference between HTTP APIs and fire and forget messaging is that the former is generally a synchronous technology, whereas the latter is asynchronous. As such, messaging doesn't need to worry about return statuses because there's nobody to notify.</p> <p><code>HTTP services</code> on the other hand needs to use the set of HTTP status codes provided by the specification. Although most APIs use a small subset, they must indicate to the requestor what the outcome of processing was so that the requestor can then decide on the next step to take.</p> <h2 id="error-handling"><a href="#error-handling" aria-hidden="true" class="header-anchor">#</a> Error Handling</h2> <p>What happens when the <code>productService</code> in the above example throws an error during processsing? For instance let's say that it tries to insert a record in a database that was being patched.</p> <p><code>HTTP Services</code> would error out and possibly return a <code>503 Service Unavailable</code> response. The requestor would then need to handle this response, and maybe throw an error of its own to indicate its work can't be completed, sending errors everywhere up the chain. This is made worse if the requestor already had completed half of a larger operation where the data is now in an incomplete state.</p> <p><code>Messaging</code> by nature provides retries when errors occur. If the command is processed and an error is thrown due to the database being unavailable, the error is logged and the message is placed back on the queue. It's then picked up, and the same operation retried with a progressive delay between attempts. Eventually the database patching will finish and the next time the command is retried the process will complete sucessfully.</p> <p>Using this approach, the requestor doesn't need to build in error handling for each command it sends out. Systems can go offline for days, but will resume normally once they're turned back on without any data loss.</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/bus/assets/js/app.3f00092a.js" defer></script><script src="/bus/assets/js/2.f96d54d9.js" defer></script><script src="/bus/assets/js/55.f140ad1b.js" defer></script>
  </body>
</html>
