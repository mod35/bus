<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Message Driven Microservices in Node | @node-ts/bus</title>
    <meta name="description" content="Enterprise message bus library for typescript">
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-139036417-1"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-139036417-1');
    </script>
    
    <link rel="preload" href="/bus/assets/css/0.styles.a0567244.css" as="style"><link rel="preload" href="/bus/assets/js/app.3f00092a.js" as="script"><link rel="preload" href="/bus/assets/js/2.f96d54d9.js" as="script"><link rel="preload" href="/bus/assets/js/3.bd8ac6f4.js" as="script"><link rel="prefetch" href="/bus/assets/js/10.b1826c5f.js"><link rel="prefetch" href="/bus/assets/js/11.f4db49b5.js"><link rel="prefetch" href="/bus/assets/js/12.441ced42.js"><link rel="prefetch" href="/bus/assets/js/13.5da12cdf.js"><link rel="prefetch" href="/bus/assets/js/14.5723ff39.js"><link rel="prefetch" href="/bus/assets/js/15.9351b1f8.js"><link rel="prefetch" href="/bus/assets/js/16.4a95aa27.js"><link rel="prefetch" href="/bus/assets/js/17.5e3a905d.js"><link rel="prefetch" href="/bus/assets/js/18.34d34a41.js"><link rel="prefetch" href="/bus/assets/js/19.37764b15.js"><link rel="prefetch" href="/bus/assets/js/20.41e534df.js"><link rel="prefetch" href="/bus/assets/js/21.a2a519df.js"><link rel="prefetch" href="/bus/assets/js/22.b1b8491f.js"><link rel="prefetch" href="/bus/assets/js/23.2cd80a85.js"><link rel="prefetch" href="/bus/assets/js/24.5c27101b.js"><link rel="prefetch" href="/bus/assets/js/25.eec315db.js"><link rel="prefetch" href="/bus/assets/js/26.578d003c.js"><link rel="prefetch" href="/bus/assets/js/27.b98c2d5c.js"><link rel="prefetch" href="/bus/assets/js/28.49e8268d.js"><link rel="prefetch" href="/bus/assets/js/29.7d5f4608.js"><link rel="prefetch" href="/bus/assets/js/30.02847ac0.js"><link rel="prefetch" href="/bus/assets/js/31.17c58c6e.js"><link rel="prefetch" href="/bus/assets/js/32.d9080668.js"><link rel="prefetch" href="/bus/assets/js/33.f2ed353a.js"><link rel="prefetch" href="/bus/assets/js/34.08e93c34.js"><link rel="prefetch" href="/bus/assets/js/35.35de18e1.js"><link rel="prefetch" href="/bus/assets/js/36.cbfbdc52.js"><link rel="prefetch" href="/bus/assets/js/37.8a3c22bb.js"><link rel="prefetch" href="/bus/assets/js/38.bd7c4504.js"><link rel="prefetch" href="/bus/assets/js/39.cd720556.js"><link rel="prefetch" href="/bus/assets/js/4.316b1088.js"><link rel="prefetch" href="/bus/assets/js/40.94efec92.js"><link rel="prefetch" href="/bus/assets/js/41.74109087.js"><link rel="prefetch" href="/bus/assets/js/42.f1a36a54.js"><link rel="prefetch" href="/bus/assets/js/43.5c78e474.js"><link rel="prefetch" href="/bus/assets/js/44.063e9286.js"><link rel="prefetch" href="/bus/assets/js/45.e6507e24.js"><link rel="prefetch" href="/bus/assets/js/46.6e36afc9.js"><link rel="prefetch" href="/bus/assets/js/47.667c6c4f.js"><link rel="prefetch" href="/bus/assets/js/48.44225a83.js"><link rel="prefetch" href="/bus/assets/js/49.134f81e0.js"><link rel="prefetch" href="/bus/assets/js/5.2df78ea4.js"><link rel="prefetch" href="/bus/assets/js/50.43c1ca10.js"><link rel="prefetch" href="/bus/assets/js/51.73f85ba2.js"><link rel="prefetch" href="/bus/assets/js/52.7f1417bf.js"><link rel="prefetch" href="/bus/assets/js/53.1ab9955f.js"><link rel="prefetch" href="/bus/assets/js/54.9181bea0.js"><link rel="prefetch" href="/bus/assets/js/55.f140ad1b.js"><link rel="prefetch" href="/bus/assets/js/56.fb3a6ebe.js"><link rel="prefetch" href="/bus/assets/js/6.2614c5a8.js"><link rel="prefetch" href="/bus/assets/js/7.089ef9d2.js"><link rel="prefetch" href="/bus/assets/js/8.78c5e104.js"><link rel="prefetch" href="/bus/assets/js/9.f03a87d7.js">
    <link rel="stylesheet" href="/bus/assets/css/0.styles.a0567244.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/bus/" class="home-link router-link-active"><!----> <span class="site-name">@node-ts/bus</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/bus/" class="nav-link">Home</a></div><div class="nav-item"><a href="/bus/packages/bus-core/src/handler/" class="nav-link">Handlers</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Transports</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bus/packages/bus-sqs/" class="nav-link">SQS</a></li><li class="dropdown-item"><!----> <a href="/bus/packages/bus-rabbitmq/" class="nav-link">RabbitMQ</a></li></ul></div></div><div class="nav-item"><a href="/bus/packages/bus-workflow/" class="nav-link">Workflows</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Persistence</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bus/packages/bus-postgres/" class="nav-link">Postgres</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/node-ts/bus" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/bus/" class="nav-link">Home</a></div><div class="nav-item"><a href="/bus/packages/bus-core/src/handler/" class="nav-link">Handlers</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Transports</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bus/packages/bus-sqs/" class="nav-link">SQS</a></li><li class="dropdown-item"><!----> <a href="/bus/packages/bus-rabbitmq/" class="nav-link">RabbitMQ</a></li></ul></div></div><div class="nav-item"><a href="/bus/packages/bus-workflow/" class="nav-link">Workflows</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Persistence</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bus/packages/bus-postgres/" class="nav-link">Postgres</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/node-ts/bus" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/bus/" class="sidebar-link">Home</a></li><li><a href="/bus/packages/bus-messages/" class="sidebar-link">Messages</a></li><li><a href="/bus/packages/bus-core/src/handler/" class="sidebar-link">Handlers</a></li><li><a href="/bus/packages/bus-core/src/transport/" class="sidebar-link">Transports</a></li><li><a href="/bus/packages/bus-workflow/" class="sidebar-link">Workflows</a></li><li><a href="/bus/packages/bus-workflow/src/workflow/persistence/" class="sidebar-link">Persistence</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="message-driven-microservices-in-node"><a href="#message-driven-microservices-in-node" aria-hidden="true" class="header-anchor">#</a> Message Driven Microservices in Node</h1> <p>Integrating services and microservices using messages is a proven and scalable pattern in many languages. In Node however, it's more popular to integrate services using HTTP. This isn't surprising given the framework was grown out of a browser engine and powers many web-based projects.</p> <p>There are a number of key advantages with message based integrations that are difficult and sometimes impossible to achieve with HTTP. We'll run through a basic evolution of a message driven microservice system in node.</p> <h2 id="what-does-a-message-based-integration-look-like"><a href="#what-does-a-message-based-integration-look-like" aria-hidden="true" class="header-anchor">#</a> What Does a Message Based Integration Look Like?</h2> <p>Consider a fictional system that deals with hotel bookings. We might create a single service that's responsible for booking a hotel room and logically looks like this:</p> <p><img src="/bus/assets/img/room-booking-service.7a676348.png" alt="Room booking service"></p> <p>From a messaging perspective, we can communicate with the service by sending a <code>command</code> to make a reservation. This command is a message, which is just a JSON object describing what we want to do. This is placed into a message queue that the room booking service monitors. Whenever a message arrives, it is read and processed by the service. Our system will look like this:</p> <p><img src="/bus/assets/img/room-booking-queue.2c43793d.png" alt="Room booking queue"></p> <p>The nice part about placing the reservations into a queue is that the room booking service can process it at its own pace. If we receive a spike of reservations or the service is offline; the messages will just queue up. All these messages will eventually be processed once the service is online. This is quite different to HTTP services where if the service is down then requests are discarded.</p> <h2 id="decoupling-the-system"><a href="#decoupling-the-system" aria-hidden="true" class="header-anchor">#</a> Decoupling the System</h2> <p>The downside to the above model is that the sender of the command needs to know which queue to place it on. That means knowledge about what services exist in our system and effectively what their queue names are. This type of coupling really hurts when systems become more complicated, and can make it difficult to refactor.</p> <p>To avoid this we can send the command to a <code>topic</code> instead. A topic is a routing mechanism that queues can subscribe to. We'd create a topic named after the command, and then subscribe the room booking queue to it. This way the sender can send commands to a topic of the same name, which will be automatically routed to the queue and service that handles that type of message. Our system now starts to look like this:</p> <p><img src="/bus/assets/img/room-booking-topic.772426b6.png" alt="Room booking topic"></p> <h2 id="adding-another-microservice"><a href="#adding-another-microservice" aria-hidden="true" class="header-anchor">#</a> Adding Another Microservice</h2> <p>At this point things are quite trivial - we have a system with a single microservice that processes bookings. The next thing we want to do is to send an email to the hotel each time a booking is made. We may decide that sending emails can be the responsibility of another service.</p> <p>Given our current knowledge, we may jump straight in and build something where the room booking service sends a command to email the hotel with a confirmation like so:</p> <p><img src="/bus/assets/img/email-confirmation-coupled.82573f7c.png" alt="Email confirmation coupled"></p> <p>This will work, but it couples together the process of booking a room with the process of sending an email confirmation to the hotel. This means that every time we book a room, a hotel email confirmation will be sent. It also means that the room booking service needs to know about and interact with the email confirmation system, and that we can no longer deal with it in isolation.</p> <p>In order to decouple the room booking system from the email confirmation system, we need a way of reporting when a new reservation has been made that can be subscribed to by other services.</p> <h2 id="publishing-changes-to-our-system"><a href="#publishing-changes-to-our-system" aria-hidden="true" class="header-anchor">#</a> Publishing Changes to Our System</h2> <p>If we want to broadcast that a command has been executed on our system, we use <code>events</code>.  These are a different type of message that just represent a historical fact that some change to our system has taken place. In our case, we want an event to be published that represents that a room booking was made.</p> <p>Events are published to a topic that shares the same name of the event. Any services that are interested in a certain type of event can subscribe their service queue to that topic. In our case, we want to subscribe the confirmation email queue to the room reserved topic. This changes our system layout slightly:</p> <p><img src="/bus/assets/img/room-reserved-event.ec9e82c3.png" alt="Room Reserved Event"></p> <p>This is great - we have two loosely coupled services. We can change our booking service, move it around, break it apart - it doesn't matter. As long as it produces a room reserved event that gets placed in the room reserved topic; the system will continue to work.</p> <p>The problem now is with our email confirmation system. In order to send a confirmation, it must consume an event. What if we want to send the same confirmation in different circumstances? Perhaps we want to delay sending until the payment has cleared?</p> <p>What we really want to do is completely decouple the two services, but <em>orchestrate</em> the logical flow of making a reservation and then sending a confirmation.</p> <h2 id="exposing-process-logic-through-workflows"><a href="#exposing-process-logic-through-workflows" aria-hidden="true" class="header-anchor">#</a> Exposing Process Logic Through Workflows</h2> <p>Workflows are a coordination/orchestration mechanism. They wait for events from one service, and then invoke the next step of their logical flow.</p> <p>Our workflow is simple and look something like this:</p> <p><img src="/bus/assets/img/workflow.3c121ca3.png" alt="Workflow"></p> <p>We can see that there is no direct connection between the room booking service and the email confirmation service. Nice! Instead, our workflow is subscribing to the room reserved events, and sending out a command to email the hotel with a confirmation each time.</p> <p>Workflows are as simple or complex as your business processes, but they serve a very important function - they allow complete decoupling of all of your services. This makes your system far more flexible to work on and change.</p> <h2 id="show-me-some-code"><a href="#show-me-some-code" aria-hidden="true" class="header-anchor">#</a> Show Me Some Code!</h2> <p>At this point you may be wondering how to achieve this in Node. Perhaps you're familiar with some queuing technologies like SQS or RabbitMQ but don't like the hassle of setting up queues, topics and managing subscriptions.</p> <p><a href="https://node-ts.github.io/bus/" target="_blank" rel="noopener noreferrer">@node-ts/bus<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is a Node library that does all of the heavy lifting of setting up message driven services, including creation of queues and topics, subscriptions, workflows, retries, routing etc.</p> <p>The following is the message handling code for the make a reservation command:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Command <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@node-ts/bus-messages'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Bus <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@node-ts/bus-core'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> MakeAReservation<span class="token punctuation">,</span> RoomReserved <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@org/contracts'</span>

@<span class="token function">HandlesMessage</span><span class="token punctuation">(</span>MakeAReservation<span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">MakeAReservationHandler</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span> <span class="token punctuation">(</span>
    <span class="token parameter">@<span class="token function">inject</span><span class="token punctuation">(</span><span class="token constant">ROOM_SERVICE</span><span class="token punctuation">)</span> <span class="token keyword">private</span> <span class="token keyword">readonly</span> roomService<span class="token punctuation">:</span> RoomService<span class="token punctuation">,</span>
    @<span class="token function">inject</span><span class="token punctuation">(</span><span class="token constant">BUS_SYMBOLS</span><span class="token punctuation">.</span>Bus<span class="token punctuation">)</span> <span class="token keyword">private</span> <span class="token keyword">readonly</span> bus<span class="token punctuation">:</span> Bus</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">handle</span> <span class="token punctuation">(</span>command<span class="token punctuation">:</span> MakeAReservation<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Pass the command to our internal service to make the reservation</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>roomService<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span>

    <span class="token comment">// Publish an event that the room has been reserved</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>bus<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RoomReserved</span><span class="token punctuation">(</span>
      command<span class="token punctuation">.</span>roomId<span class="token punctuation">,</span>
      command<span class="token punctuation">.</span>customerId<span class="token punctuation">,</span>
      command<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">,</span>
      command<span class="token punctuation">.</span>to
    <span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>When our service runs, any commands to make a reservation will find their way to this handle function. Under the hood <a href="https://node-ts.github.io/bus/" target="_blank" rel="noopener noreferrer">@node-ts/bus<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> will:</p> <ul><li>Create a topic for the <code>MakeAReservation</code> command</li> <li>Create a service queue for the room booking services</li> <li>Subscribe the service queue to the command topic</li> <li>Listen to the service queue, and dispatch any <code>MakeAReservation</code> commands to this handler function</li></ul> <p>If later you decide to move this handler to a different service, <a href="https://node-ts.github.io/bus/" target="_blank" rel="noopener noreferrer">@node-ts/bus<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> will subscribe that service's queue to the command topic and the system will continue as normal.</p> <h2 id="what-does-the-workflow-code-look-like"><a href="#what-does-the-workflow-code-look-like" aria-hidden="true" class="header-anchor">#</a> What Does the Workflow Code Look Like?</h2> <p>The workflow only operates on messages like commands and events. It's not allowed to query databases or anything else, as it should only model the flow of logic through your business. In our case the code is trivial:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> TestWorkflowData <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./test-workflow-data'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">BUS_SYMBOLS</span><span class="token punctuation">,</span> Bus <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@node-ts/bus-core'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Workflow<span class="token punctuation">,</span> StartedBy<span class="token punctuation">,</span> Handles <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@node-ts/bus-workflow'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> RoomReserved<span class="token punctuation">,</span> EmailHotelConfirmation <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@org/contracts'</span>

@<span class="token function">injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BookingWorkflow</span> <span class="token keyword">extends</span> <span class="token class-name">Workflow</span><span class="token operator">&lt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>

  <span class="token keyword">constructor</span> <span class="token punctuation">(</span>
    <span class="token parameter">@<span class="token function">inject</span><span class="token punctuation">(</span><span class="token constant">BUS_SYMBOLS</span><span class="token punctuation">.</span>Bus<span class="token punctuation">)</span> <span class="token keyword">private</span> <span class="token keyword">readonly</span> bus<span class="token punctuation">:</span> Bus</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  @Handles<span class="token operator">&lt;</span>RoomReserved<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'handleRoomReserved'</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>RoomReserved<span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">handleRoomReserved</span> <span class="token punctuation">(</span>event<span class="token punctuation">:</span> RoomReserved<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Partial<span class="token operator">&lt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> command <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EmailHotelConfirmation</span><span class="token punctuation">(</span>
      event<span class="token punctuation">.</span>roomId<span class="token punctuation">,</span>
      event<span class="token punctuation">.</span>customerId<span class="token punctuation">,</span>
      event<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">,</span>
      event<span class="token punctuation">.</span>to
    <span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>bus<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This workflow starts whenever a <code>RoomReserved</code> event is received, sends the <code>EmailHotelConfirmation</code> command and completes immediately. <a href="https://node-ts.github.io/bus/" target="_blank" rel="noopener noreferrer">@node-ts/bus<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> will take care of creating and subscribing the underlying queue infrastructure so that the service hosting the workflow will receive all messages that the workflow susbcribes to.</p> <p>In the real world, workflows can take minutes to months to complete depending on the business process. Data related to the current state of the workflow is retrieved and persisted on each message handling event. This allows the process to run for as long as is needed, across many services, and can resume processing like nothing happened even if the system goes offline.</p> <h2 id="conclusion"><a href="#conclusion" aria-hidden="true" class="header-anchor">#</a> Conclusion</h2> <p>These are the fundamental building blocks of building a loosely coupled message driven microservice architecture in node. Even though these types of systems are more common in other languages, we hope that <a href="https://node-ts.github.io/bus/" target="_blank" rel="noopener noreferrer">@node-ts/bus<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> can help node developers enjoy the same level of system resiliency, reliability and flexibility and not feel like HTTP integrations are the only option.</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/bus/assets/js/app.3f00092a.js" defer></script><script src="/bus/assets/js/2.f96d54d9.js" defer></script><script src="/bus/assets/js/3.bd8ac6f4.js" defer></script>
  </body>
</html>
